<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة شؤون الطلاب - مدرسة الثروات الوطنية الخاصة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        // Firebase configuration
         const firebaseConfig = {
            apiKey: "AIzaSyClTn7DSCMDVoR6K2j5ioT3gy9xjQ8Yz40",
            authDomain: "students-account-dashboard.firebaseapp.com",
            databaseURL: "https://students-account-dashboard-default-rtdb.firebaseio.com",
            projectId: "students-account-dashboard",
            storageBucket: "students-account-dashboard.firebasestorage.app",
            messagingSenderId: "328099689342",
            appId: "1:328099689342:web:5fadd8d5112100fbed392f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = { db, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
        
        :root {
            /* Primary Colors - نظام الألوان الأساسي */
            --color-primary: #2563eb;
            --color-primary-dark: #1d4ed8;
            --color-primary-light: #60a5fa;
            --color-secondary: #475569;
            --color-accent: #3b82f6;
            
            /* Success & Status Colors */
            --color-success: #059669;
            --color-success-light: #10b981;
            --color-warning: #d97706;
            --color-warning-light: #f59e0b;
            --color-danger: #dc2626;
            --color-danger-light: #ef4444;
            --color-info: #0ea5e9;
            --color-info-light: #38bdf8;
            
            /* Neutral Colors - Light Mode */
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f8fafc;
            --color-bg-tertiary: #f1f5f9;
            --color-text-primary: #1e293b;
            --color-text-secondary: #64748b;
            --color-text-tertiary: #94a3b8;
            --color-border: #e2e8f0;
            --color-border-light: #f1f5f9;
            
            /* Card & Component Colors */
            --color-card-bg: #ffffff;
            --color-card-border: #e2e8f0;
            --color-input-bg: #ffffff;
            --color-input-border: #d1d5db;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-shadow-lg: rgba(0, 0, 0, 0.15);
        }
        
        .dark {
            /* Dark Mode Colors */
            --color-bg-primary: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-tertiary: #334155;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-tertiary: #94a3b8;
            --color-border: #374151;
            --color-border-light: #4b5563;
            --color-card-bg: #1e293b;
            --color-card-border: #374151;
            --color-input-bg: #374151;
            --color-input-border: #4b5563;
            --color-shadow: rgba(0, 0, 0, 0.3);
            --color-shadow-lg: rgba(0, 0, 0, 0.4);
        }
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        /* Animations */
        .notification-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Enhanced Gradients */
        .gradient-bg {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 50%, var(--color-primary-light) 100%);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.2);
        }
        
        .gradient-bg-soft {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .dark .gradient-bg-soft {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        /* Glass Effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark .glass-effect {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced Card Styles */
        .card-enhanced {
            background: var(--color-card-bg);
            border: 2px solid var(--color-card-border);
            border-radius: 16px;
            box-shadow: 0 4px 6px var(--color-shadow);
            transition: all 0.3s ease;
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px var(--color-shadow-lg);
            border-color: var(--color-primary-light);
        }
        
        /* Status Indicators with better colors */
        .status-indicator {
            position: relative;
            padding-left: 20px;
        }
        
        .status-indicator::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 0 3px currentColor;
        }
        
        .status-pending::before { 
            background-color: var(--color-warning);
            color: var(--color-warning);
            opacity: 0.3;
        }
        .status-approved::before { 
            background-color: var(--color-success);
            color: var(--color-success);
            opacity: 0.3;
        }
        .status-rejected::before { 
            background-color: var(--color-danger);
            color: var(--color-danger);
            opacity: 0.3;
        }
        .status-archived::before { 
            background-color: #8b5cf6;
            color: #8b5cf6;
            opacity: 0.3;
        }
        
        /* Enhanced Search Highlight */
        .search-highlight {
            background: linear-gradient(120deg, #fef08a 0%, #fbbf24 100%);
            color: #92400e;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);
        }
        
        .dark .search-highlight {
            background: linear-gradient(120deg, #451a03 0%, #78350f 100%);
            color: #fef08a;
        }
        
        /* Button Enhancements */
        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border: none;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--color-success) 0%, var(--color-success-light) 100%);
            box-shadow: 0 4px 14px rgba(5, 150, 105, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--color-danger) 0%, var(--color-danger-light) 100%);
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--color-warning) 0%, var(--color-warning-light) 100%);
            box-shadow: 0 4px 14px rgba(217, 119, 6, 0.3);
        }

        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }
        
        /* Form Enhancements */
        .form-input {
            background: var(--color-input-bg);
            border: 2px solid var(--color-input-border);
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .form-input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }
        
        /* Stats Cards */
        .stats-card {
            background: var(--color-card-bg);
            border: 2px solid var(--color-border);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
        }
        
        /* Notification Styles */
        .notification-item {
            border: 2px solid var(--color-border);
            border-radius: 12px;
            background: var(--color-card-bg);
            transition: all 0.3s ease;
        }
        
        .notification-item:hover {
            border-color: var(--color-primary-light);
            box-shadow: 0 4px 12px var(--color-shadow);
        }
        
        .notification-unread {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 197, 253, 0.05));
            border-color: var(--color-primary-light);
        }
        
        /* Modal Enhancements */
        .modal-content {
            background: var(--color-card-bg);
            border: 2px solid var(--color-border);
            border-radius: 24px;
            box-shadow: 0 25px 50px var(--color-shadow-lg);
        }
        
        /* Modal overlay clickable */
        .modal-overlay {
            cursor: pointer;
        }
        
        .modal-content {
            cursor: default;
        }
        
        /* Print Document */
        .print-document {
            font-family: Arial, sans-serif;
            background: white;
            color: black;
        }
        
        /* Login Specific Styles */
        .login-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 20%, rgba(59, 130, 246, 0.3), transparent 50%),
                        radial-gradient(circle at 70% 80%, rgba(139, 92, 246, 0.3), transparent 50%);
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive Improvements */
        @media (max-width: 768px) {
            .card-hover:hover {
                transform: none;
            }
            
            .stats-card {
                margin-bottom: 16px;
            }
            
            .action-buttons-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons-container > * {
                margin-bottom: 0.5rem;
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Accessibility Improvements */
        .focus-visible {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--color-bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-dark);
        }

        /* Enhanced Button Container */
        .buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 640px) {
            .buttons-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .buttons-container > button {
                width: 100%;
                justify-content: center;
                margin-bottom: 0.5rem;
            }
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        'primary-dark': '#1d4ed8',
                        'primary-light': '#60a5fa',
                        secondary: '#475569',
                        accent: '#3b82f6',
                        success: '#059669',
                        warning: '#d97706',
                        danger: '#dc2626',
                        info: '#0ea5e9'
                    },
                    fontFamily: {
                        'arabic': ['Cairo', 'sans-serif']
                    },
                    spacing: {
                        '18': '4.5rem',
                        '88': '22rem',
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                        '3xl': '2rem',
                    }
                }
            }
        }
        
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 font-arabic min-h-screen">
    <div id="app" class="min-h-screen">
        <!-- Login Screen -->
        <div id="loginScreen" class="min-h-screen login-bg flex items-center justify-center p-4">
            <div class="login-card p-8 w-full max-w-md mx-4 relative z-10">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-6 backdrop-blur-sm border-2 border-blue-400/30">
                        <i class="fas fa-graduation-cap text-4xl text-blue-400"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white mb-2">مدرسة الثروات الوطنية الخاصة</h1>
                    <h2 class="text-xl font-semibold text-white/90 mb-2">نظام إدارة شؤون الطلاب</h2>
                    <p class="text-white/80 text-sm">تسجيل الدخول للنظام</p>
                    <div id="userIpDisplay" class="text-white/70 text-xs mt-2"></div>
                </div>
                
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-white/90 mb-2">اسم المستخدم</label>
                        <div class="relative">
                            <i class="fas fa-user absolute right-4 top-1/2 transform -translate-y-1/2 text-white/60"></i>
                            <input type="text" id="username" class="w-full pr-12 pl-4 py-4 text-base border-2 border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/10 text-white placeholder-white/70 backdrop-blur-sm transition-all form-input" placeholder="أدخل اسم المستخدم">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-white/90 mb-2">كلمة المرور</label>
                        <div class="relative">
                            <i class="fas fa-lock absolute right-4 top-1/2 transform -translate-y-1/2 text-white/60"></i>
                            <input type="password" id="password" class="w-full pr-12 pl-12 py-4 text-base border-2 border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/10 text-white placeholder-white/70 backdrop-blur-sm transition-all form-input" placeholder="أدخل كلمة المرور">
                            <button type="button" onclick="togglePassword()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/70 hover:text-white transition-colors">
                                <i id="passwordToggleIcon" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="loginError" class="hidden bg-red-500/20 border-2 border-red-400/30 rounded-xl p-4 backdrop-blur-sm">
                        <p class="text-red-200 text-sm"></p>
                    </div>
                    
                    <button type="submit" class="w-full bg-white/20 hover:bg-white/30 text-white py-4 rounded-xl font-medium transition-all backdrop-blur-sm border-2 border-white/30 flex items-center justify-center space-x-3 space-x-reverse btn-primary">
                        <i class="fas fa-sign-in-alt text-lg"></i>
                        <span class="text-lg">تسجيل الدخول</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- Header -->
            <header class="gradient-bg shadow-xl border-b-2 border-blue-400/20">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-18">
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                                <i class="fas fa-graduation-cap text-2xl text-blue-500"></i>
                            </div>
                            <div>
                                <h1 class="text-lg font-bold text-white">مدرسة الثروات الوطنية الخاصة</h1>
                                <p class="text-white/80 text-sm">نظام إدارة شؤون الطلاب</p>
                            </div>
                            <span id="userRole" class="text-sm bg-white/20 text-white px-4 py-2 rounded-full backdrop-blur-sm border border-white/30"></span>
                        </div>
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <button id="printBtn" class="p-3 text-white/80 hover:text-white hover:bg-white/10 rounded-xl transition-all" title="طباعة">
                                <i class="fas fa-print text-xl"></i>
                            </button>
                            <button id="exportBtn" class="p-3 text-white/80 hover:text-white hover:bg-white/10 rounded-xl transition-all" title="تصدير إكسل">
                                <i class="fas fa-file-excel text-xl"></i>
                            </button>
                            <button id="notificationsBtn" class="relative p-3 text-white/80 hover:text-white hover:bg-white/10 rounded-xl transition-all">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center notification-badge font-bold">0</span>
                            </button>
                            <button id="homeBtn" class="p-3 text-white/80 hover:text-white hover:bg-white/10 rounded-xl transition-all">
                                <i class="fas fa-home text-xl"></i>
                            </button>
                            <button onclick="showLogoutConfirmation()" class="p-3 text-white/80 hover:text-red-300 hover:bg-red-500/10 rounded-xl transition-all">
                                <i class="fas fa-sign-out-alt text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Dashboard Screen -->
                <div id="dashboardScreen" class="fade-in">
                    <div class="flex flex-col lg:flex-row justify-between items-start mb-8 space-y-4 lg:space-y-0">
                        <div class="text-center lg:text-right flex-1">
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent mb-4">لوحة التحكم</h2>
                            <p class="text-slate-600 dark:text-slate-300 text-lg">مرحباً بك في نظام إدارة شؤون الطلاب</p>
                            <div class="text-sm text-slate-500 dark:text-slate-400 mt-2">
                                <span>عنوان IP الخاص بك: </span><span id="dashboardIpDisplay" class="font-mono bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded"></span>
                            </div>
                        </div>
                        <!-- Dashboard Logout Button -->
                        <div class="flex flex-col items-end space-y-2">
                            <button onclick="showLogoutConfirmation()" class="btn-logout text-white px-6 py-3 rounded-xl font-medium transition-all shadow-lg flex items-center space-x-2 space-x-reverse">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>تسجيل الخروج</span>
                            </button>
                            <div class="text-sm text-slate-500 dark:text-slate-400">
                                <span id="currentUserInfo"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                        <div class="stats-card p-6 card-hover cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="w-14 h-14 bg-blue-100 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center">
                                        <i class="fas fa-file-alt text-blue-600 dark:text-blue-400 text-2xl"></i>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">إجمالي الطلبات</p>
                                    <p id="totalRequests" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">جميع الطلبات</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card p-6 card-hover cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="w-14 h-14 bg-yellow-100 dark:bg-yellow-900/30 rounded-2xl flex items-center justify-center">
                                        <i class="fas fa-clock text-yellow-600 dark:text-yellow-400 text-2xl"></i>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">قيد المراجعة</p>
                                    <p id="pendingRequests" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">تحتاج مراجعة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card p-6 card-hover cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="w-14 h-14 bg-green-100 dark:bg-green-900/30 rounded-2xl flex items-center justify-center">
                                        <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-2xl"></i>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">مقبولة</p>
                                    <p id="approvedRequests" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">تم قبولها</p>
                                </div>
                            </div>
                        </div>

                        <div class="stats-card p-6 card-hover cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="w-14 h-14 bg-red-100 dark:bg-red-900/30 rounded-2xl flex items-center justify-center">
                                        <i class="fas fa-times-circle text-red-600 dark:text-red-400 text-2xl"></i>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">مرفوضة</p>
                                    <p id="rejectedRequests" class="text-3xl font-bold text-slate-900 dark:text-white">0</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">تم رفضها</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div id="quickActions" class="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto">
                        <!-- Will be populated based on user role -->
                    </div>
                </div>

                <!-- Student Affairs Screen -->
                <div id="studentAffairsScreen" class="hidden">
                    <div class="space-y-6">
                        <!-- Header Section with improved layout -->
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 space-y-4 lg:space-y-0">
                            <div>
                                <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent mb-2">شؤون الطلاب</h2>
                                <p class="text-slate-600 dark:text-slate-300">إدارة طلبات الطلاب والخدمات الأكاديمية</p>
                            </div>
                            
                            <!-- Main Action Buttons -->
                            <div class="buttons-container justify-end">
                                <button onclick="showLogoutConfirmation()" class="btn-logout text-white px-4 py-2 rounded-xl font-medium transition-all shadow-lg flex items-center space-x-2 space-x-reverse">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>خروج</span>
                                </button>
                                <button onclick="printSelectedRequests()" class="btn-warning text-white px-6 py-3 rounded-xl font-medium transition-all shadow-lg flex items-center space-x-2 space-x-reverse">
                                    <i class="fas fa-print"></i>
                                    <span>طباعة المحدد</span>
                                </button>
                                <button onclick="exportStudentRequests()" class="btn-success text-white px-6 py-3 rounded-xl font-medium transition-all shadow-lg flex items-center space-x-2 space-x-reverse">
                                    <i class="fas fa-file-excel"></i>
                                    <span>تصدير إكسل</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Action Buttons Section -->
                        <div class="card-enhanced p-6 mb-6">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                                <i class="fas fa-cogs mr-3 text-blue-500"></i>
                                الإجراءات السريعة
                            </h3>
                            <div class="buttons-container">
                                <button onclick="showAddRequest()" class="btn-primary text-white px-8 py-4 rounded-2xl font-medium transition-all shadow-lg flex items-center space-x-3 space-x-reverse">
                                    <i class="fas fa-plus text-lg"></i>
                                    <span class="text-lg">إضافة طلب جديد</span>
                                </button>
                                <button onclick="showStudentRequests()" class="bg-slate-600 hover:bg-slate-700 text-white px-8 py-4 rounded-2xl font-medium transition-all shadow-lg flex items-center space-x-3 space-x-reverse">
                                    <i class="fas fa-list text-lg"></i>
                                    <span class="text-lg">جميع الطلبات</span>
                                </button>
                                <button onclick="exportStudentRequests()" class="btn-success text-white px-8 py-4 rounded-2xl font-medium transition-all shadow-lg flex items-center space-x-3 space-x-reverse">
                                    <i class="fas fa-file-excel text-lg"></i>
                                    <span class="text-lg">تصدير البيانات</span>
                                </button>
                                <button onclick="showPrintModal()" class="btn-warning text-white px-8 py-4 rounded-2xl font-medium transition-all shadow-lg flex items-center space-x-3 space-x-reverse">
                                    <i class="fas fa-print text-lg"></i>
                                    <span class="text-lg">طباعة التقارير</span>
                                </button>
                            </div>
                        </div>

                        <!-- Enhanced Search and Filter -->
                        <div class="card-enhanced p-6 mb-6">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                                <i class="fas fa-search mr-3 text-blue-500"></i>
                                البحث والفلترة المتقدمة
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">البحث</label>
                                    <input type="text" id="studentSearchInput" placeholder="البحث في الطلبات..." class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">الحالة</label>
                                    <select id="studentStatusFilter" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-white form-input">
                                        <option value="">جميع الحالات</option>
                                        <option value="pending">قيد المراجعة</option>
                                        <option value="approved">مقبول</option>
                                        <option value="rejected">مرفوض</option>
                                        <option value="archived">مؤرشف</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">نوع الطلب</label>
                                    <select id="studentTypeFilter" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-white form-input">
                                        <option value="">جميع الأنواع</option>
                                        <option value="transfer">نقل طالب</option>
                                        <option value="certificate">إصدار شهادة</option>
                                        <option value="unlock">إزالة لوك</option>
                                        <option value="registration_completion">إكمال إجراء التسجيل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">السنة الدراسية</label>
                                    <select id="studentAcademicYearFilter" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-white form-input">
                                        <option value="">جميع السنوات</option>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Filter Actions -->
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0 text-sm text-slate-600 dark:text-slate-400">
                                <span>عدد النتائج: <span id="studentResultsCount" class="font-semibold text-blue-600 dark:text-blue-400">0</span></span>
                                <div class="flex flex-wrap gap-4">
                                    <button onclick="clearStudentFilters()" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium transition-colors flex items-center space-x-1 space-x-reverse">
                                        <i class="fas fa-times"></i>
                                        <span>مسح الفلاتر</span>
                                    </button>
                                    <button onclick="toggleArchiveView()" id="toggleArchiveBtn" class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-medium transition-colors flex items-center space-x-1 space-x-reverse">
                                        <i class="fas fa-archive"></i>
                                        <span>عرض الأرشيف</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Request Form -->
                    <div id="addRequestForm" class="hidden card-enhanced p-8">
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-8 flex items-center">
                            <i class="fas fa-plus-circle mr-3 text-blue-500"></i>
                            إضافة طلب جديد
                        </h3>
                        
                        <form id="requestForm" class="space-y-6">
                            <!-- Request Type -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">نوع الطلب <span class="text-red-500">*</span></label>
                                <select id="requestType" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                    <option value="">اختر نوع الطلب</option>
                                    <option value="transfer">نقل طالب</option>
                                    <option value="certificate">إصدار شهادة</option>
                                    <option value="unlock">إزالة لوك</option>
                                    <option value="registration_completion">إكمال إجراء التسجيل</option>
                                </select>
                            </div>

                            <!-- Student Info -->
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">اسم الطالب <span class="text-red-500">*</span></label>
                                    <input type="text" id="studentName" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">رقم الهوية <span class="text-red-500">*</span></label>
                                    <input type="text" id="studentId" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                </div>
                            </div>

                            <div class="grid md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">الصف <span class="text-red-500">*</span></label>
                                    <input type="text" id="studentGrade" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">السنة الدراسية <span class="text-red-500">*</span></label>
                                    <select id="academicYear" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">الفصل الدراسي <span class="text-red-500">*</span></label>
                                    <select id="semester" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                        <option value="">اختر الفصل</option>
                                        <option value="first">الفصل الأول</option>
                                        <option value="second">الفصل الثاني</option>
                                        <option value="third">الفصل الثالث</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Dynamic Fields -->
                            <div id="dynamicFields"></div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ملاحظات إضافية</label>
                                <textarea id="requestNotes" rows="4" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input"></textarea>
                            </div>

                            <div class="flex justify-end space-x-4 space-x-reverse pt-6 border-t-2 border-slate-200 dark:border-slate-700">
                                <button type="button" onclick="cancelRequest()" class="px-8 py-3 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium transition-colors bg-slate-100 dark:bg-slate-800 rounded-xl">إلغاء</button>
                                <button type="submit" class="btn-primary text-white px-8 py-3 rounded-xl font-medium transition-all shadow-lg">
                                    <span id="submitButtonText">إرسال الطلب</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Student Requests List -->
                    <div id="studentRequestsList" class="hidden">
                        <div id="studentRequestsContent" class="space-y-6"></div>
                    </div>
                </div>

                <!-- Accounting Screen -->
                <div id="accountingScreen" class="hidden">
                    <div class="mb-8">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 space-y-4 lg:space-y-0">
                            <div>
                                <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent mb-2">المحاسبة</h2>
                                <p class="text-slate-600 dark:text-slate-300">مراجعة والموافقة على طلبات الطلاب</p>
                            </div>
                            <div class="buttons-container justify-end">
                                <button onclick="showLogoutConfirmation()" class="btn-logout text-white px-4 py-2 rounded-xl font-medium transition-all shadow-lg flex items-center space-x-2 space-x-reverse">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>خروج</span>
                                </button>
                                <button onclick="exportAccountingRequests()" class="btn-success text-white px-6 py-3 rounded-xl font-medium transition-all shadow-lg flex items-center space-x-2 space-x-reverse">
                                    <i class="fas fa-file-excel"></i>
                                    <span>تصدير تقرير إكسل</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Advanced Search and Filter -->
                        <div class="card-enhanced p-6 mb-6">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                                <i class="fas fa-search mr-3 text-blue-500"></i>
                                البحث والفلترة المتقدمة
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">البحث</label>
                                    <input type="text" id="accountingSearchInput" placeholder="البحث في الطلبات..." class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">الحالة</label>
                                    <select id="accountingStatusFilter" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-white form-input">
                                        <option value="">جميع الحالات</option>
                                        <option value="pending">قيد المراجعة</option>
                                        <option value="approved">مقبول</option>
                                        <option value="rejected">مرفوض</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">نوع الطلب</label>
                                    <select id="accountingTypeFilter" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-white form-input">
                                        <option value="">جميع الأنواع</option>
                                        <option value="transfer">نقل طالب</option>
                                        <option value="certificate">إصدار شهادة</option>
                                        <option value="unlock">إزالة لوك</option>
                                        <option value="registration_completion">إكمال إجراء التسجيل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">التاريخ</label>
                                    <select id="accountingDateFilter" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-white form-input">
                                        <option value="">جميع التواريخ</option>
                                        <option value="today">اليوم</option>
                                        <option value="week">هذا الأسبوع</option>
                                        <option value="month">هذا الشهر</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">الإجراءات</label>
                                    <button onclick="clearAccountingFilters()" class="w-full px-4 py-3 bg-slate-500 hover:bg-slate-600 text-white rounded-xl transition-all">
                                        مسح الفلاتر
                                    </button>
                                </div>
                            </div>

                            <!-- Sorting and Results -->
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-4 space-x-reverse">
                                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">ترتيب حسب:</label>
                                    <select id="accountingSortBy" class="px-3 py-2 border-2 border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm form-input">
                                        <option value="submittedAt">تاريخ الإرسال</option>
                                        <option value="studentName">اسم الطالب</option>
                                        <option value="type">نوع الطلب</option>
                                        <option value="status">الحالة</option>
                                    </select>
                                    <select id="accountingSortOrder" class="px-3 py-2 border-2 border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm form-input">
                                        <option value="desc">تنازلي</option>
                                        <option value="asc">تصاعدي</option>
                                    </select>
                                </div>
                                <div class="text-sm text-slate-600 dark:text-slate-400">
                                    عدد النتائج: <span id="accountingResultsCount" class="font-semibold text-blue-600 dark:text-blue-400">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="accountingRequestsList" class="space-y-6"></div>
                </div>
            </main>
        </div>

        <!-- Print Modal -->
        <div id="printModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'printModal')">
            <div class="modal-content max-w-4xl w-full mx-4 max-h-96 overflow-hidden" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700 gradient-bg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-white">طباعة المستندات</h3>
                        <button onclick="closePrintModal()" class="text-white/80 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">اختر الطلبات للطباعة:</label>
                        <div id="printRequestsList" class="max-h-60 overflow-y-auto border-2 border-slate-300 dark:border-slate-600 rounded-xl p-4 bg-slate-50 dark:bg-slate-800"></div>
                    </div>
                    <div class="flex justify-end space-x-4 space-x-reverse">
                        <button onclick="closePrintModal()" class="px-6 py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors bg-slate-100 dark:bg-slate-800 rounded-xl">إلغاء</button>
                        <button onclick="executePrint()" class="btn-primary text-white px-6 py-2 rounded-xl transition-all shadow-lg">
                            <i class="fas fa-print mr-1"></i>طباعة
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Modal -->
        <div id="notificationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'notificationsModal')">
            <div class="modal-content max-w-md w-full mx-4 max-h-96 overflow-hidden" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700 gradient-bg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-bell mr-3"></i>التنبيهات
                        </h3>
                        <button onclick="closeNotifications()" class="text-white/80 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="notificationsContent" class="p-4 overflow-y-auto max-h-80"></div>
            </div>
        </div>

        <!-- Request Details Modal -->
        <div id="requestDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'requestDetailsModal')">
            <div class="modal-content max-w-4xl w-full mx-4 max-h-96 overflow-hidden" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700 gradient-bg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-file-alt mr-3"></i>تفاصيل الطلب
                        </h3>
                        <button onclick="closeRequestDetails()" class="text-white/80 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="requestDetailsContent" class="p-6 overflow-y-auto max-h-80"></div>
            </div>
        </div>

        <!-- Edit Request Modal -->
        <div id="editRequestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'editRequestModal')">
            <div class="modal-content max-w-4xl w-full mx-4 max-h-96 overflow-hidden" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700 gradient-bg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-edit mr-3"></i>تعديل الطلب
                        </h3>
                        <button onclick="closeEditRequest()" class="text-white/80 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="editRequestContent" class="p-6 overflow-y-auto max-h-80"></div>
            </div>
        </div>

        <!-- Reject Reason Modal -->
        <div id="rejectReasonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'rejectReasonModal')">
            <div class="modal-content max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center">
                            <i class="fas fa-times-circle mr-3 text-red-500"></i>سبب الرفض
                        </h3>
                        <button onclick="closeRejectReason()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <textarea id="rejectReason" rows="4" placeholder="اكتب سبب رفض الطلب..." class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input" required></textarea>
                    <div class="flex justify-end space-x-4 space-x-reverse mt-6">
                        <button onclick="closeRejectReason()" class="px-6 py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors bg-slate-100 dark:bg-slate-800 rounded-xl">إلغاء</button>
                        <button onclick="confirmReject()" class="btn-danger text-white px-6 py-2 rounded-xl transition-all shadow-lg">تأكيد الرفض</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'deleteConfirmModal')">
            <div class="modal-content max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center">
                            <i class="fas fa-exclamation-triangle mr-3 text-yellow-500"></i>تأكيد الحذف
                        </h3>
                        <button onclick="closeDeleteConfirm()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-slate-700 dark:text-slate-300 mb-6">هل أنت متأكد من حذف هذا الطلب؟ سيتم الحذف من جميع الأقسام ولا يمكن التراجع عن هذا الإجراء.</p>
                    <div class="flex justify-end space-x-4 space-x-reverse">
                        <button onclick="closeDeleteConfirm()" class="px-6 py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors bg-slate-100 dark:bg-slate-800 rounded-xl">إلغاء</button>
                        <button onclick="confirmDelete()" class="btn-danger text-white px-6 py-2 rounded-xl transition-all shadow-lg">حذف نهائي</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Archive Confirmation Modal -->
        <div id="archiveConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'archiveConfirmModal')">
            <div class="modal-content max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center">
                            <i class="fas fa-archive mr-3 text-purple-500"></i>تأكيد الأرشفة
                        </h3>
                        <button onclick="closeArchiveConfirm()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-slate-700 dark:text-slate-300 mb-6">هل أنت متأكد من أرشفة هذا الطلب؟ سيتم إخفاؤه من قسم المحاسبة.</p>
                    <div class="flex justify-end space-x-4 space-x-reverse">
                        <button onclick="closeArchiveConfirm()" class="px-6 py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors bg-slate-100 dark:bg-slate-800 rounded-xl">إلغاء</button>
                        <button onclick="confirmArchive()" class="btn-purple text-white px-6 py-2 rounded-xl transition-all shadow-lg">أرشفة</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unarchive Confirmation Modal -->
        <div id="unarchiveConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'unarchiveConfirmModal')">
            <div class="modal-content max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center">
                            <i class="fas fa-undo mr-3 text-green-500"></i>إرجاع من الأرشيف
                        </h3>
                        <button onclick="closeUnarchiveConfirm()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-slate-700 dark:text-slate-300 mb-6">هل أنت متأكد من إرجاع هذا الطلب من الأرشيف؟ سيظهر مرة أخرى في قسم المحاسبة.</p>
                    <div class="flex justify-end space-x-4 space-x-reverse">
                        <button onclick="closeUnarchiveConfirm()" class="px-6 py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors bg-slate-100 dark:bg-slate-800 rounded-xl">إلغاء</button>
                        <button onclick="confirmUnarchive()" class="btn-success text-white px-6 py-2 rounded-xl transition-all shadow-lg">إرجاع</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logout Confirmation Modal -->
        <div id="logoutConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay" onclick="closeModalOnOverlayClick(event, 'logoutConfirmModal')">
            <div class="modal-content max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="p-6 border-b-2 border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center">
                            <i class="fas fa-sign-out-alt mr-3 text-red-500"></i>تأكيد تسجيل الخروج
                        </h3>
                        <button onclick="closeLogoutConfirm()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        <p class="text-slate-700 dark:text-slate-300 mb-4">هل أنت متأكد من تسجيل الخروج من النظام؟</p>
                        <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4">
                            <div class="text-sm text-slate-600 dark:text-slate-400 space-y-2">
                                <p><span class="font-medium">المستخدم:</span> <span id="logoutUserName"></span></p>
                                <p><span class="font-medium">القسم:</span> <span id="logoutUserRole"></span></p>
                                <p><span class="font-medium">وقت الدخول:</span> <span id="logoutLoginTime"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 space-x-reverse">
                        <button onclick="closeLogoutConfirm()" class="px-6 py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors bg-slate-100 dark:bg-slate-800 rounded-xl">إلغاء</button>
                        <button onclick="confirmLogout()" class="btn-logout text-white px-6 py-2 rounded-xl transition-all shadow-lg">
                            <i class="fas fa-sign-out-alt mr-1"></i>تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Audio for Notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGcdBjiR1/LNeSsFJHfH8N2QAA=" type="audio/wav">
    </audio>

    <script>
        // App State
        let currentUser = null;
        let currentScreen = 'login';
        let currentRequestToReject = null;
        let currentRequestToDelete = null;
        let currentRequestToArchive = null;
        let currentRequestToEdit = null;
        let allRequests = [];
        let filteredRequests = [];
        let notifications = [];
        let selectedRequests = [];
        let userIP = '';
        let showingArchive = false;

        // User credentials
        const users = {
            'students': { password: 'stud123', role: 'شؤون الطلاب', department: 'studentAffairs' },
            'account': { password: 'acc123', role: 'المحاسبة', department: 'accounting' }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAcademicYears();
            setupEventListeners();
            loadInitialData();
            getUserIP();
            loadUserSession(); // استعادة جلسة المستخدم
        });

        // Get User IP Address
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userIP = data.ip;
                const ipDisplays = document.querySelectorAll('#userIpDisplay, #dashboardIpDisplay');
                ipDisplays.forEach(display => {
                    if (display) display.textContent = userIP;
                });
            } catch (error) {
                console.error('Error getting IP:', error);
                userIP = 'غير متاح';
            }
        }

        function initializeAcademicYears() {
            const currentYear = new Date().getFullYear();
            const academicYearSelect = document.getElementById('academicYear');
            const filterSelect = document.getElementById('studentAcademicYearFilter');
            
            for (let year = currentYear; year <= 2050; year++) {
                const nextYear = year + 1;
                const option = `<option value="${year}-${nextYear}">${year}-${nextYear}</option>`;
                if (academicYearSelect) academicYearSelect.innerHTML += option;
                if (filterSelect) filterSelect.innerHTML += option;
            }
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Search and filter inputs
            document.getElementById('studentSearchInput')?.addEventListener('input', filterStudentRequests);
            document.getElementById('studentStatusFilter')?.addEventListener('change', filterStudentRequests);
            document.getElementById('studentTypeFilter')?.addEventListener('change', filterStudentRequests);
            document.getElementById('studentAcademicYearFilter')?.addEventListener('change', filterStudentRequests);

            document.getElementById('accountingSearchInput')?.addEventListener('input', filterAccountingRequests);
            document.getElementById('accountingStatusFilter')?.addEventListener('change', filterAccountingRequests);
            document.getElementById('accountingTypeFilter')?.addEventListener('change', filterAccountingRequests);
            document.getElementById('accountingDateFilter')?.addEventListener('change', filterAccountingRequests);
            document.getElementById('accountingSortBy')?.addEventListener('change', filterAccountingRequests);
            document.getElementById('accountingSortOrder')?.addEventListener('change', filterAccountingRequests);

            // Form inputs
            document.getElementById('requestType')?.addEventListener('change', updateDynamicFields);
            document.getElementById('requestForm')?.addEventListener('submit', handleSubmitRequest);
            
            // Navigation buttons
            document.getElementById('homeBtn')?.addEventListener('click', showDashboard);
            document.getElementById('notificationsBtn')?.addEventListener('click', showNotifications);
            document.getElementById('printBtn')?.addEventListener('click', () => showPrintModal());
            document.getElementById('exportBtn')?.addEventListener('click', exportCurrentData);
            
            // Escape key للإغلاق
            document.addEventListener('keydown', handleEscapeKey);
        }

        // Session Management - حفظ واستعادة جلسة المستخدم
        function saveUserSession() {
            if (currentUser) {
                const sessionData = {
                    username: currentUser.username,
                    role: currentUser.role,
                    department: currentUser.department,
                    loginTime: currentUser.loginTime,
                    loginIP: currentUser.loginIP
                };
                localStorage.setItem('userSession', JSON.stringify(sessionData));
            }
        }

        function loadUserSession() {
            try {
                const sessionData = localStorage.getItem('userSession');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    // التحقق من صحة الجلسة (أقل من 24 ساعة)
                    const sessionAge = new Date() - new Date(session.loginTime);
                    const maxAge = 24 * 60 * 60 * 1000; // 24 ساعة بالميلي ثانية
                    
                    if (sessionAge < maxAge) {
                        currentUser = session;
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        document.getElementById('userRole').textContent = session.role;
                        updateUserInfo();
                        showDashboard();
                        updateStats();
                    } else {
                        // الجلسة منتهية الصلاحية
                        clearUserSession();
                    }
                }
            } catch (error) {
                console.error('Error loading session:', error);
                clearUserSession();
            }
        }

        function clearUserSession() {
            localStorage.removeItem('userSession');
            currentUser = null;
        }

        function updateUserInfo() {
            if (currentUser) {
                const userInfo = document.getElementById('currentUserInfo');
                if (userInfo) {
                    const loginDate = new Date(currentUser.loginTime);
                    userInfo.textContent = `${currentUser.username} - دخل في ${loginDate.toLocaleString('ar-EG')}`;
                }
            }
        }

        // Archive Functions - وظائف الأرشفة
        function toggleArchiveView() {
            showingArchive = !showingArchive;
            const toggleBtn = document.getElementById('toggleArchiveBtn');
            
            if (showingArchive) {
                toggleBtn.innerHTML = '<i class="fas fa-list mr-1"></i>عرض العادي';
                document.getElementById('studentStatusFilter').value = 'archived';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-archive mr-1"></i>عرض الأرشيف';
                document.getElementById('studentStatusFilter').value = '';
            }
            
            filterStudentRequests();
        }

        function archiveRequest(requestId) {
            currentRequestToArchive = requestId;
            document.getElementById('archiveConfirmModal').classList.remove('hidden');
        }

        async function confirmArchive() {
            try {
                const request = allRequests.find(r => r.id === currentRequestToArchive);
                if (!request) return;

                const updatedData = {
                    status: 'archived',
                    archivedAt: new Date().toISOString(),
                    archivedBy: currentUser.role,
                    archivedFromIP: userIP
                };

                if (window.firebase) {
                    const docRef = window.firebase.doc(window.firebase.db, 'requests', currentRequestToArchive);
                    await window.firebase.updateDoc(docRef, updatedData);
                }

                Object.assign(request, updatedData);
                localStorage.setItem('requests', JSON.stringify(allRequests));

                showCustomAlert('تم أرشفة الطلب بنجاح');
                closeArchiveConfirm();
                loadStudentRequests();
                updateStats();

            } catch (error) {
                console.error('Error archiving request:', error);
                showCustomAlert('حدث خطأ أثناء أرشفة الطلب');
            }
        }

        function unarchiveRequest(requestId) {
            currentRequestToArchive = requestId;
            document.getElementById('unarchiveConfirmModal').classList.remove('hidden');
        }

        async function confirmUnarchive() {
            try {
                const request = allRequests.find(r => r.id === currentRequestToArchive);
                if (!request) return;

                // إرجاع الحالة إلى ما كانت عليه أو إلى قيد المراجعة
                const updatedData = {
                    status: request.originalStatus || 'pending',
                    archivedAt: null,
                    archivedBy: null,
                    archivedFromIP: null,
                    restoredAt: new Date().toISOString(),
                    restoredBy: currentUser.role,
                    restoredFromIP: userIP
                };

                if (window.firebase) {
                    const docRef = window.firebase.doc(window.firebase.db, 'requests', currentRequestToArchive);
                    await window.firebase.updateDoc(docRef, updatedData);
                }

                Object.assign(request, updatedData);
                localStorage.setItem('requests', JSON.stringify(allRequests));

                showCustomAlert('تم إرجاع الطلب من الأرشيف بنجاح');
                closeUnarchiveConfirm();
                loadStudentRequests();
                updateStats();

            } catch (error) {
                console.error('Error unarchiving request:', error);
                showCustomAlert('حدث خطأ أثناء إرجاع الطلب من الأرشيف');
            }
        }

        function closeArchiveConfirm() {
            document.getElementById('archiveConfirmModal').classList.add('hidden');
            currentRequestToArchive = null;
        }

        function closeUnarchiveConfirm() {
            document.getElementById('unarchiveConfirmModal').classList.add('hidden');
            currentRequestToArchive = null;
        }

        // Modal Management - إدارة النوافذ المنبثقة
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                // إغلاق جميع النوافذ المفتوحة
                const modals = [
                    'printModal',
                    'notificationsModal', 
                    'requestDetailsModal',
                    'editRequestModal',
                    'rejectReasonModal',
                    'deleteConfirmModal',
                    'archiveConfirmModal',
                    'unarchiveConfirmModal',
                    'logoutConfirmModal'
                ];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && !modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                    }
                });
            }
        }

        function closeModalOnOverlayClick(event, modalId) {
            // إغلاق النافذة عند الضغط على الخلفية
            if (event.target === event.currentTarget) {
                document.getElementById(modalId).classList.add('hidden');
            }
        }

        // Logout Functions - وظائف تسجيل الخروج
        function showLogoutConfirmation() {
            if (currentUser) {
                document.getElementById('logoutUserName').textContent = currentUser.username;
                document.getElementById('logoutUserRole').textContent = currentUser.role;
                document.getElementById('logoutLoginTime').textContent = new Date(currentUser.loginTime).toLocaleString('ar-EG');
                document.getElementById('logoutConfirmModal').classList.remove('hidden');
            }
        }

        function closeLogoutConfirm() {
            document.getElementById('logoutConfirmModal').classList.add('hidden');
        }

        function confirmLogout() {
            logout();
            closeLogoutConfirm();
        }

        async function loadInitialData() {
            try {
                if (window.firebase) {
                    const requestsRef = window.firebase.collection(window.firebase.db, 'requests');
                    const querySnapshot = await window.firebase.getDocs(requestsRef);
                    
                    allRequests = [];
                    querySnapshot.forEach((doc) => {
                        allRequests.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const notificationsRef = window.firebase.collection(window.firebase.db, 'notifications');
                    const notifSnapshot = await window.firebase.getDocs(notificationsRef);
                    
                    notifications = [];
                    notifSnapshot.forEach((doc) => {
                        notifications.push({ id: doc.id, ...doc.data() });
                    });
                }
            } catch (error) {
                console.error('Error loading data:', error);
                allRequests = JSON.parse(localStorage.getItem('requests')) || [];
                notifications = JSON.parse(localStorage.getItem('notifications')) || [];
            }
        }

        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(error => console.log('Audio play failed:', error));
            }
        }

        // Authentication
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                showLoginError('يرجى إدخال اسم المستخدم وكلمة المرور');
                return;
            }
            
            const user = users[username];
            if (!user || user.password !== password) {
                showLoginError('اسم المستخدم أو كلمة المرور غير صحيحة');
                return;
            }
            
            currentUser = { username, ...user, loginIP: userIP, loginTime: new Date() };
            saveUserSession(); // حفظ الجلسة
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userRole').textContent = user.role;
            updateUserInfo();
            
            showDashboard();
            updateStats();
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function logout() {
            clearUserSession(); // مسح الجلسة
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginForm').reset();
            selectedRequests = [];
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Navigation
        function showDashboard() {
            hideAllScreens();
            document.getElementById('dashboardScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('fade-in');
            currentScreen = 'dashboard';
            updateQuickActions();
            updateStats();
        }

        function showStudentAffairs() {
            hideAllScreens();
            document.getElementById('studentAffairsScreen').classList.remove('hidden');
            currentScreen = 'studentAffairs';
            showStudentRequests();
        }

        function showAccounting() {
            hideAllScreens();
            document.getElementById('accountingScreen').classList.remove('hidden');
            currentScreen = 'accounting';
            loadAccountingRequests();
        }

        function hideAllScreens() {
            const screens = ['dashboardScreen', 'studentAffairsScreen', 'accountingScreen'];
            screens.forEach(screen => {
                const element = document.getElementById(screen);
                if (element) {
                    element.classList.add('hidden');
                    element.classList.remove('fade-in');
                }
            });
        }

        function updateQuickActions() {
            const quickActions = document.getElementById('quickActions');
            if (!quickActions) return;
            
            if (currentUser.department === 'studentAffairs') {
                quickActions.innerHTML = `
                    <div class="card-enhanced p-10 text-center card-hover cursor-pointer" onclick="showStudentAffairs()">
                        <div class="w-24 h-24 gradient-bg rounded-full flex items-center justify-center mx-auto mb-8">
                            <i class="fas fa-user-graduate text-4xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">إدارة الطلبات</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-6 leading-relaxed">إنشاء ومتابعة الطلبات الخاصة بالطلاب وإكمال إجراءات التسجيل</p>
                        <div class="flex justify-center space-x-2 space-x-reverse">
                            <span class="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1 rounded-full text-sm">طلبات جديدة</span>
                            <span class="bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 px-3 py-1 rounded-full text-sm">تتبع</span>
                        </div>
                    </div>
                    <div class="card-enhanced p-10 text-center">
                        <div class="w-24 h-24 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-8">
                            <i class="fas fa-chart-bar text-4xl text-slate-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">إحصائيات سريعة</h3>
                        <div class="space-y-3 text-right">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-300">الطلبات النشطة:</span>
                                <span class="font-bold text-blue-600 dark:text-blue-400">${allRequests.filter(r => r.status === 'pending' && r.submittedBy === currentUser.role).length}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-300">المقبولة اليوم:</span>
                                <span class="font-bold text-green-600 dark:text-green-400">${allRequests.filter(r => r.status === 'approved' && new Date(r.processedAt).toDateString() === new Date().toDateString()).length}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                quickActions.innerHTML = `
                    <div class="card-enhanced p-10 text-center card-hover cursor-pointer" onclick="showAccounting()">
                        <div class="w-24 h-24 gradient-bg rounded-full flex items-center justify-center mx-auto mb-8">
                            <i class="fas fa-calculator text-4xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">مراجعة الطلبات</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-6 leading-relaxed">مراجعة والموافقة على جميع أنواع الطلبات وإكمال إجراءات التسجيل</p>
                        <div class="flex justify-center space-x-2 space-x-reverse">
                            <span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 px-3 py-1 rounded-full text-sm">مراجعة</span>
                            <span class="bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 px-3 py-1 rounded-full text-sm">موافقة</span>
                        </div>
                    </div>
                    <div class="card-enhanced p-10 text-center">
                        <div class="w-24 h-24 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-8">
                            <i class="fas fa-chart-line text-4xl text-slate-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">تحليلات متقدمة</h3>
                        <div class="space-y-3 text-right">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-300">تحتاج مراجعة:</span>
                                <span class="font-bold text-orange-600 dark:text-orange-400">${allRequests.filter(r => r.status === 'pending' && r.status !== 'archived').length}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-300">معدل الموافقة:</span>
                                <span class="font-bold text-blue-600 dark:text-blue-400">${allRequests.length > 0 ? Math.round(allRequests.filter(r => r.status === 'approved').length / allRequests.filter(r => r.status !== 'archived').length * 100) : 0}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateStats() {
            const total = allRequests.filter(r => r.status !== 'archived').length;
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const rejected = allRequests.filter(r => r.status === 'rejected').length;
            
            document.getElementById('totalRequests').textContent = total;
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('approvedRequests').textContent = approved;
            document.getElementById('rejectedRequests').textContent = rejected;
        }

        // Student Affairs Functions
        function showAddRequest() {
            document.getElementById('addRequestForm').classList.remove('hidden');
            document.getElementById('studentRequestsList').classList.add('hidden');
            document.getElementById('requestForm').reset();
            document.getElementById('dynamicFields').innerHTML = '';
            document.getElementById('submitButtonText').textContent = 'إرسال الطلب';
            currentRequestToEdit = null;
        }

        function showStudentRequests() {
            document.getElementById('addRequestForm').classList.add('hidden');
            document.getElementById('studentRequestsList').classList.remove('hidden');
            loadStudentRequests();
        }

        function cancelRequest() {
            showStudentRequests();
        }

        function updateDynamicFields() {
            const requestType = document.getElementById('requestType').value;
            const dynamicFields = document.getElementById('dynamicFields');
            
            let fieldsHTML = '';
            
            switch(requestType) {
                case 'transfer':
                    fieldsHTML = `
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">القسم الحالي <span class="text-red-500">*</span></label>
                                <input type="text" id="currentDepartment" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">القسم المراد النقل إليه <span class="text-red-500">*</span></label>
                                <input type="text" id="targetDepartment" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">سبب النقل <span class="text-red-500">*</span></label>
                            <textarea id="transferReason" rows="4" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input"></textarea>
                        </div>
                    `;
                    break;
                case 'certificate':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">نوع الشهادة <span class="text-red-500">*</span></label>
                            <select id="certificateType" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                <option value="">اختر نوع الشهادة</option>
                                <option value="enrollment">شهادة إثبات قيد</option>
                                <option value="grades">شهادة درجات</option>
                                <option value="graduation">شهادة تخرج</option>
                                <option value="conduct">شهادة حسن سير وسلوك</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'unlock':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">سبب إزالة اللوك <span class="text-red-500">*</span></label>
                            <textarea id="unlockReason" rows="4" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input"></textarea>
                        </div>
                    `;
                    break;
                case 'registration_completion':
                    fieldsHTML = `
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">المرحلة الحالية <span class="text-red-500">*</span></label>
                                <select id="currentStage" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input">
                                    <option value="">اختر المرحلة</option>
                                    <option value="documents_submission">تسليم الوثائق</option>
                                    <option value="medical_examination">الفحص الطبي</option>
                                    <option value="fees_payment">دفع الرسوم</option>
                                    <option value="final_approval">الموافقة النهائية</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">الإجراء المطلوب <span class="text-red-500">*</span></label>
                                <input type="text" id="requiredAction" required class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input" placeholder="مثال: استكمال أوراق القبول">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">تفاصيل إضافية</label>
                            <textarea id="registrationDetails" rows="3" class="w-full px-4 py-3 text-base border-2 border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-700 text-slate-900 dark:text-white transition-all form-input" placeholder="أي تفاصيل أو ملاحظات إضافية حول إجراء التسجيل"></textarea>
                        </div>
                    `;
                    break;
            }
            
            dynamicFields.innerHTML = fieldsHTML;
        }

        async function handleSubmitRequest(e) {
            e.preventDefault();
            
            const requestType = document.getElementById('requestType').value;
            const studentName = document.getElementById('studentName').value;
            const studentId = document.getElementById('studentId').value;
            const studentGrade = document.getElementById('studentGrade').value;
            const academicYear = document.getElementById('academicYear').value;
            const semester = document.getElementById('semester').value;
            const requestNotes = document.getElementById('requestNotes').value;

            const request = {
                type: requestType,
                studentName,
                studentId,
                studentGrade,
                academicYear,
                semester,
                notes: requestNotes,
                status: 'pending',
                submittedAt: new Date().toISOString(),
                submittedBy: currentUser.role,
                submittedFromIP: userIP,
                submittedByUser: currentUser.username
            };

            // Add specific fields based on request type
            if (requestType === 'transfer') {
                request.currentDepartment = document.getElementById('currentDepartment').value;
                request.targetDepartment = document.getElementById('targetDepartment').value;
                request.transferReason = document.getElementById('transferReason').value;
            } else if (requestType === 'certificate') {
                request.certificateType = document.getElementById('certificateType').value;
            } else if (requestType === 'unlock') {
                request.unlockReason = document.getElementById('unlockReason').value;
            } else if (requestType === 'registration_completion') {
                request.currentStage = document.getElementById('currentStage').value;
                request.requiredAction = document.getElementById('requiredAction').value;
                request.registrationDetails = document.getElementById('registrationDetails').value;
            }

            try {
                if (currentRequestToEdit) {
                    if (window.firebase) {
                        const docRef = window.firebase.doc(window.firebase.db, 'requests', currentRequestToEdit);
                        await window.firebase.updateDoc(docRef, request);
                    }
                    
                    const index = allRequests.findIndex(r => r.id === currentRequestToEdit);
                    if (index !== -1) {
                        allRequests[index] = { id: currentRequestToEdit, ...request };
                    }
                    
                    showCustomAlert('تم تعديل الطلب بنجاح');
                } else {
                    if (window.firebase) {
                        const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'requests'), request);
                        request.id = docRef.id;
                    } else {
                        request.id = Date.now().toString();
                    }
                    
                    allRequests.push(request);
                    await addNotification('accounting', `طلب جديد: ${getRequestTypeText(requestType)} - ${studentName}`, 'new');
                    showCustomAlert('تم إرسال الطلب بنجاح');
                }
                
                localStorage.setItem('requests', JSON.stringify(allRequests));
                showStudentRequests();
                updateStats();
                
            } catch (error) {
                console.error('Error submitting request:', error);
                showCustomAlert('حدث خطأ أثناء إرسال الطلب');
            }
        }

        function loadStudentRequests() {
            filterStudentRequests();
        }

        function filterStudentRequests() {
            const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('studentStatusFilter').value;
            const typeFilter = document.getElementById('studentTypeFilter').value;
            const yearFilter = document.getElementById('studentAcademicYearFilter').value;
            
            let filtered = allRequests.filter(r => r.submittedBy === currentUser.role);
            
            if (searchTerm) {
                filtered = filtered.filter(r =>
                    r.studentName.toLowerCase().includes(searchTerm) ||
                    r.studentId.includes(searchTerm) ||
                    getRequestTypeText(r.type).toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(r => r.status === statusFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(r => r.type === typeFilter);
            }
            
            if (yearFilter) {
                filtered = filtered.filter(r => r.academicYear === yearFilter);
            }
            
            document.getElementById('studentResultsCount').textContent = filtered.length;
            displayStudentRequests(filtered, searchTerm);
        }

        function clearStudentFilters() {
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentStatusFilter').value = '';
            document.getElementById('studentTypeFilter').value = '';
            document.getElementById('studentAcademicYearFilter').value = '';
            showingArchive = false;
            document.getElementById('toggleArchiveBtn').innerHTML = '<i class="fas fa-archive mr-1"></i>عرض الأرشيف';
            filterStudentRequests();
        }

        function displayStudentRequests(requests, searchTerm = '') {
            const content = document.getElementById('studentRequestsContent');
            
            if (requests.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-16 card-enhanced">
                        <i class="fas fa-inbox text-6xl text-slate-300 dark:text-slate-600 mb-6"></i>
                        <h3 class="text-xl font-semibold text-slate-500 dark:text-slate-400 mb-2">لا توجد طلبات مطابقة</h3>
                        <p class="text-slate-400 dark:text-slate-500">جرب تعديل معايير البحث أو إضافة طلب جديد</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = requests.map(request => `
                <div class="card-enhanced p-6 card-hover ${request.status === 'archived' ? 'border-purple-300 dark:border-purple-600 bg-purple-50/30 dark:bg-purple-900/10' : ''}">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <div class="w-14 h-14 ${request.status === 'archived' ? 'bg-purple-500' : 'gradient-bg'} rounded-2xl flex items-center justify-center">
                                <i class="${getRequestTypeIcon(request.type)} text-white text-xl"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-slate-900 dark:text-white">${highlightSearchTerm(getRequestTypeText(request.type), searchTerm)}</h4>
                                <p class="text-slate-600 dark:text-slate-400">${highlightSearchTerm(request.studentName, searchTerm)} - ${request.studentGrade}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="px-4 py-2 rounded-full text-sm font-medium status-indicator status-${request.status} ${getStatusStyle(request.status)}">
                                ${getStatusText(request.status)}
                            </span>
                            <input type="checkbox" class="request-checkbox w-4 h-4 text-blue-600" value="${request.id}" onchange="toggleRequestSelection('${request.id}')">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-sm">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-slate-500 dark:text-slate-400 block mb-1">رقم الهوية</span>
                            <span class="font-medium text-slate-900 dark:text-white">${highlightSearchTerm(request.studentId, searchTerm)}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-slate-500 dark:text-slate-400 block mb-1">السنة الدراسية</span>
                            <span class="font-medium text-slate-900 dark:text-white">${request.academicYear}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-slate-500 dark:text-slate-400 block mb-1">الفصل الدراسي</span>
                            <span class="font-medium text-slate-900 dark:text-white">${getSemesterText(request.semester)}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-slate-500 dark:text-slate-400 block mb-1">تاريخ الإرسال</span>
                            <span class="font-medium text-slate-900 dark:text-white">${formatDateGregorian(request.submittedAt)}</span>
                        </div>
                    </div>
                    
                    ${request.status === 'rejected' && request.rejectReason ? `
                        <div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl p-4 mb-4">
                            <div class="flex items-start space-x-3 space-x-reverse">
                                <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                                <div>
                                    <h5 class="font-medium text-red-700 dark:text-red-300 mb-1">سبب الرفض</h5>
                                    <p class="text-sm text-red-600 dark:text-red-400">${request.rejectReason}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${request.status === 'archived' && request.archivedAt ? `
                        <div class="bg-purple-50 dark:bg-purple-900/20 border-2 border-purple-200 dark:border-purple-800 rounded-xl p-4 mb-4">
                            <div class="flex items-start space-x-3 space-x-reverse">
                                <i class="fas fa-archive text-purple-500 mt-1"></i>
                                <div>
                                    <h5 class="font-medium text-purple-700 dark:text-purple-300 mb-1">تم الأرشفة</h5>
                                    <p class="text-sm text-purple-600 dark:text-purple-400">تاريخ الأرشفة: ${formatDateGregorian(request.archivedAt)}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0 pt-4 border-t-2 border-slate-200 dark:border-slate-700">
                        <button onclick="viewRequestDetails('${request.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium flex items-center space-x-2 space-x-reverse transition-colors">
                            <i class="fas fa-eye"></i>
                            <span>عرض التفاصيل</span>
                        </button>
                        <div class="flex flex-wrap gap-2">
                            ${request.status === 'pending' ? `
                                <button onclick="editRequest('${request.id}')" class="btn-warning text-white px-4 py-2 rounded-xl text-sm transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-edit"></i>
                                    <span>تعديل</span>
                                </button>
                            ` : ''}
                            ${request.status === 'archived' ? `
                                <button onclick="unarchiveRequest('${request.id}')" class="btn-success text-white px-4 py-2 rounded-xl text-sm transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-undo"></i>
                                    <span>إرجاع</span>
                                </button>
                            ` : (request.status === 'approved' || request.status === 'rejected') ? `
                                <button onclick="archiveRequest('${request.id}')" class="btn-purple text-white px-4 py-2 rounded-xl text-sm transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-archive"></i>
                                    <span>أرشفة</span>
                                </button>
                            ` : ''}
                            <button onclick="deleteRequest('${request.id}')" class="btn-danger text-white px-4 py-2 rounded-xl text-sm transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                <i class="fas fa-trash"></i>
                                <span>حذف</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleRequestSelection(requestId) {
            const index = selectedRequests.indexOf(requestId);
            if (index === -1) {
                selectedRequests.push(requestId);
            } else {
                selectedRequests.splice(index, 1);
            }
        }

        function editRequest(requestId) {
            const request = allRequests.find(r => r.id === requestId);
            if (!request) return;
            
            currentRequestToEdit = requestId;
            
            document.getElementById('requestType').value = request.type;
            document.getElementById('studentName').value = request.studentName;
            document.getElementById('studentId').value = request.studentId;
            document.getElementById('studentGrade').value = request.studentGrade;
            document.getElementById('academicYear').value = request.academicYear;
            document.getElementById('semester').value = request.semester;
            document.getElementById('requestNotes').value = request.notes || '';
            
            updateDynamicFields();
            
            setTimeout(() => {
                if (request.type === 'transfer') {
                    document.getElementById('currentDepartment').value = request.currentDepartment || '';
                    document.getElementById('targetDepartment').value = request.targetDepartment || '';
                    document.getElementById('transferReason').value = request.transferReason || '';
                } else if (request.type === 'certificate') {
                    document.getElementById('certificateType').value = request.certificateType || '';
                } else if (request.type === 'unlock') {
                    document.getElementById('unlockReason').value = request.unlockReason || '';
                } else if (request.type === 'registration_completion') {
                    document.getElementById('currentStage').value = request.currentStage || '';
                    document.getElementById('requiredAction').value = request.requiredAction || '';
                    document.getElementById('registrationDetails').value = request.registrationDetails || '';
                }
            }, 100);
            
            document.getElementById('submitButtonText').textContent = 'تحديث الطلب';
            showAddRequest();
        }

        function deleteRequest(requestId) {
            currentRequestToDelete = requestId;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        async function confirmDelete() {
            try {
                if (window.firebase) {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'requests', currentRequestToDelete));
                }
                
                allRequests = allRequests.filter(r => r.id !== currentRequestToDelete);
                localStorage.setItem('requests', JSON.stringify(allRequests));
                
                showCustomAlert('تم حذف الطلب بنجاح من جميع الأقسام');
                closeDeleteConfirm();
                loadStudentRequests();
                updateStats();
                
            } catch (error) {
                console.error('Error deleting request:', error);
                showCustomAlert('حدث خطأ أثناء حذف الطلب');
            }
        }

        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            currentRequestToDelete = null;
        }

        // Accounting Functions
        function loadAccountingRequests() {
            filterAccountingRequests();
        }

        function filterAccountingRequests() {
            const searchTerm = document.getElementById('accountingSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('accountingStatusFilter').value;
            const typeFilter = document.getElementById('accountingTypeFilter').value;
            const dateFilter = document.getElementById('accountingDateFilter').value;
            const sortBy = document.getElementById('accountingSortBy').value;
            const sortOrder = document.getElementById('accountingSortOrder').value;
            
            // تصفية الطلبات لاستبعاد المؤرشفة من قسم المحاسبة
            let filtered = allRequests.filter(r => r.submittedBy !== currentUser.role && r.status !== 'archived');
            
            if (searchTerm) {
                filtered = filtered.filter(r =>
                    r.studentName.toLowerCase().includes(searchTerm) ||
                    r.studentId.includes(searchTerm) ||
                    getRequestTypeText(r.type).toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(r => r.status === statusFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(r => r.type === typeFilter);
            }
            
            if (dateFilter) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                filtered = filtered.filter(r => {
                    const requestDate = new Date(r.submittedAt);
                    const requestDay = new Date(requestDate.getFullYear(), requestDate.getMonth(), requestDate.getDate());
                    
                    switch(dateFilter) {
                        case 'today':
                            return requestDay.getTime() === today.getTime();
                        case 'week':
                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return requestDay >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                            return requestDay >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // Sort
            filtered.sort((a, b) => {
                let aValue = a[sortBy];
                let bValue = b[sortBy];
                
                if (sortBy === 'submittedAt') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                }
                
                if (sortOrder === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            document.getElementById('accountingResultsCount').textContent = filtered.length;
            displayAccountingRequests(filtered, searchTerm);
        }

        function displayAccountingRequests(requests, searchTerm = '') {
            const content = document.getElementById('accountingRequestsList');
            
            if (requests.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-16 card-enhanced">
                        <i class="fas fa-inbox text-6xl text-slate-300 dark:text-slate-600 mb-6"></i>
                        <h3 class="text-xl font-semibold text-slate-500 dark:text-slate-400 mb-2">لا توجد طلبات مطابقة</h3>
                        <p class="text-slate-400 dark:text-slate-500">جرب تعديل معايير البحث أو الفلاتر</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = requests.map(request => `
                <div class="card-enhanced p-6 card-hover">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center">
                                <i class="${getRequestTypeIcon(request.type)} text-white text-2xl"></i>
                            </div>
                            <div>
                                <h4 class="text-xl font-bold text-slate-900 dark:text-white mb-1">${highlightSearchTerm(getRequestTypeText(request.type), searchTerm)}</h4>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <span class="px-4 py-2 rounded-full text-sm font-medium status-indicator status-${request.status} ${getStatusStyle(request.status)}">
                                        ${getStatusText(request.status)}
                                    </span>
                                    ${request.status === 'pending' ? '<span class="bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-2 py-1 rounded text-xs">يتطلب إجراء</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-slate-500 dark:text-slate-400 text-left">
                            <span>IP: ${request.submittedFromIP || 'غير متاح'}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-xs text-slate-500 dark:text-slate-400 block mb-1">الطالب</span>
                            <span class="font-bold text-slate-900 dark:text-white text-sm">${highlightSearchTerm(request.studentName, searchTerm)}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-xs text-slate-500 dark:text-slate-400 block mb-1">رقم الهوية</span>
                            <span class="font-bold text-slate-900 dark:text-white text-sm">${highlightSearchTerm(request.studentId, searchTerm)}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-xs text-slate-500 dark:text-slate-400 block mb-1">الصف</span>
                            <span class="font-bold text-slate-900 dark:text-white text-sm">${request.studentGrade}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-xs text-slate-500 dark:text-slate-400 block mb-1">السنة الدراسية</span>
                            <span class="font-bold text-slate-900 dark:text-white text-sm">${request.academicYear}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <span class="text-xs text-slate-500 dark:text-slate-400 block mb-1">تاريخ الإرسال</span>
                            <span class="font-bold text-slate-900 dark:text-white text-sm">${formatDateGregorian(request.submittedAt)}</span>
                        </div>
                    </div>
                    
                    ${request.processedAt ? `
                        <div class="flex items-center space-x-2 space-x-reverse text-sm text-slate-600 dark:text-slate-300 mb-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                            <i class="fas fa-clock text-slate-400"></i>
                            <span>تم المعالجة في: ${formatDateGregorian(request.processedAt)} بواسطة ${request.processedBy}</span>
                        </div>
                    ` : ''}
                    
                    ${request.status === 'rejected' && request.rejectReason ? `
                        <div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl p-4 mb-4">
                            <div class="flex items-start space-x-3 space-x-reverse">
                                <i class="fas fa-times-circle text-red-500 mt-1"></i>
                                <div>
                                    <h5 class="font-medium text-red-700 dark:text-red-300 mb-1">سبب الرفض</h5>
                                    <p class="text-sm text-red-600 dark:text-red-400">${request.rejectReason}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0 pt-4 border-t-2 border-slate-200 dark:border-slate-700">
                        <button onclick="viewRequestDetails('${request.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium flex items-center space-x-2 space-x-reverse transition-colors">
                            <i class="fas fa-file-alt"></i>
                            <span>عرض التفاصيل الكاملة</span>
                        </button>
                        ${request.status === 'pending' ? `
                            <div class="flex flex-wrap gap-3">
                                <button onclick="approveRequest('${request.id}')" class="btn-success text-white px-6 py-2 rounded-xl text-sm transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-check"></i>
                                    <span>موافقة</span>
                                </button>
                                <button onclick="rejectRequest('${request.id}')" class="btn-danger text-white px-6 py-2 rounded-xl text-sm transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-times"></i>
                                    <span>رفض</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function clearAccountingFilters() {
            document.getElementById('accountingSearchInput').value = '';
            document.getElementById('accountingStatusFilter').value = '';
            document.getElementById('accountingTypeFilter').value = '';
            document.getElementById('accountingDateFilter').value = '';
            filterAccountingRequests();
        }

        async function approveRequest(requestId) {
            try {
                const request = allRequests.find(r => r.id === requestId);
                if (!request) return;

                // حفظ الحالة الأصلية لاستخدامها عند إرجاع الأرشفة
                request.originalStatus = 'approved';

                const updatedData = {
                    status: 'approved',
                    processedAt: new Date().toISOString(),
                    processedBy: currentUser.role,
                    processedFromIP: userIP
                };

                if (window.firebase) {
                    const docRef = window.firebase.doc(window.firebase.db, 'requests', requestId);
                    await window.firebase.updateDoc(docRef, updatedData);
                }

                Object.assign(request, updatedData);
                localStorage.setItem('requests', JSON.stringify(allRequests));

                await addNotification('studentAffairs', `تم قبول الطلب: ${getRequestTypeText(request.type)} - ${request.studentName}`, 'approved');

                showCustomAlert('تم قبول الطلب بنجاح');
                loadAccountingRequests();
                updateStats();

            } catch (error) {
                console.error('Error approving request:', error);
                showCustomAlert('حدث خطأ أثناء الموافقة على الطلب');
            }
        }

        function rejectRequest(requestId) {
            currentRequestToReject = requestId;
            document.getElementById('rejectReasonModal').classList.remove('hidden');
        }

        async function confirmReject() {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                showCustomAlert('يرجى كتابة سبب الرفض');
                return;
            }

            try {
                const request = allRequests.find(r => r.id === currentRequestToReject);
                if (!request) return;

                // حفظ الحالة الأصلية لاستخدامها عند إرجاع الأرشفة
                request.originalStatus = 'rejected';

                const updatedData = {
                    status: 'rejected',
                    rejectReason: reason,
                    processedAt: new Date().toISOString(),
                    processedBy: currentUser.role,
                    processedFromIP: userIP
                };

                if (window.firebase) {
                    const docRef = window.firebase.doc(window.firebase.db, 'requests', currentRequestToReject);
                    await window.firebase.updateDoc(docRef, updatedData);
                }

                Object.assign(request, updatedData);
                localStorage.setItem('requests', JSON.stringify(allRequests));

                await addNotification('studentAffairs', `تم رفض الطلب: ${getRequestTypeText(request.type)} - ${request.studentName}`, 'rejected');

                showCustomAlert('تم رفض الطلب');
                closeRejectReason();
                loadAccountingRequests();
                updateStats();

            } catch (error) {
                console.error('Error rejecting request:', error);
                showCustomAlert('حدث خطأ أثناء رفض الطلب');
            }
        }

        function closeRejectReason() {
            document.getElementById('rejectReasonModal').classList.add('hidden');
            document.getElementById('rejectReason').value = '';
            currentRequestToReject = null;
        }

        // Print Functions
        function showPrintModal() {
            const studentRequests = allRequests.filter(r => r.submittedBy === currentUser.role);
            
            if (studentRequests.length === 0) {
                showCustomAlert('لا توجد طلبات للطباعة');
                return;
            }

            const listHTML = studentRequests.map(request => `
                <div class="flex items-center space-x-3 space-x-reverse py-3 border-b-2 border-slate-200 dark:border-slate-700">
                    <input type="checkbox" class="print-checkbox w-4 h-4 text-blue-600" value="${request.id}" ${selectedRequests.includes(request.id) ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="font-medium text-slate-900 dark:text-white">${getRequestTypeText(request.type)}</div>
                        <div class="text-sm text-slate-600 dark:text-slate-400">${request.studentName} - ${request.studentId}</div>
                    </div>
                    <div class="text-sm text-slate-500 dark:text-slate-400">${formatDateGregorian(request.submittedAt)}</div>
                </div>
            `).join('');

            document.getElementById('printRequestsList').innerHTML = listHTML;
            document.getElementById('printModal').classList.remove('hidden');
        }

        function closePrintModal() {
            document.getElementById('printModal').classList.add('hidden');
        }

        function executePrint() {
            const checkboxes = document.querySelectorAll('.print-checkbox:checked');
            const requestIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (requestIds.length === 0) {
                showCustomAlert('يرجى اختيار طلب واحد على الأقل للطباعة');
                return;
            }

            const requestsToPrint = allRequests.filter(r => requestIds.includes(r.id));
            printRequests(requestsToPrint);
            closePrintModal();
        }

        function printRequests(requests) {
            const printWindow = window.open('', '_blank');
            const printContent = generatePrintDocument(requests);
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function generatePrintDocument(requests) {
            return `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>مدرسة الثروات الوطنية الخاصة - تقرير الطلبات</title>
                    <style>
                        * { font-family: 'Arial', sans-serif; }
                        body { margin: 0; padding: 20px; background: white; color: black; }
                        .header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; }
                        .logo { width: 80px; height: 80px; margin: 0 auto 15px; background: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; }
                        .school-name { font-size: 24px; font-weight: bold; color: #2563eb; margin-bottom: 10px; }
                        .document-title { font-size: 18px; color: #666; }
                        .request-card { border: 2px solid #e2e8f0; margin-bottom: 20px; page-break-inside: avoid; border-radius: 12px; overflow: hidden; }
                        .request-header { background: #f8fafc; padding: 15px; border-bottom: 2px solid #e2e8f0; }
                        .request-body { padding: 15px; }
                        .field-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
                        .field-label { font-weight: bold; color: #475569; }
                        .field-value { color: #1e293b; }
                        .status-approved { color: #059669; }
                        .status-pending { color: #d97706; }
                        .status-rejected { color: #dc2626; }
                        .status-archived { color: #8b5cf6; }
                        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; border-top: 2px solid #e2e8f0; padding-top: 15px; }
                        @media print { body { margin: 0; } .no-print { display: none; } }
                    </style>
                </head>
                <body class="print-document">
                    <div class="header">
                        <div class="logo">🎓</div>
                        <div class="school-name">مدرسة الثروات الوطنية الخاصة</div>
                        <div class="document-title">تقرير طلبات شؤون الطلاب</div>
                        <div style="font-size: 14px; color: #888; margin-top: 10px;">تاريخ الطباعة: ${formatDateGregorian(new Date().toISOString())}</div>
                    </div>
                    
                    ${requests.map((request, index) => `
                        <div class="request-card">
                            <div class="request-header">
                                <h3 style="margin: 0; color: #2563eb;">${index + 1}. ${getRequestTypeText(request.type)}</h3>
                            </div>
                            <div class="request-body">
                                <div class="field-row">
                                    <div><span class="field-label">اسم الطالب:</span> <span class="field-value">${request.studentName}</span></div>
                                    <div><span class="field-label">رقم الهوية:</span> <span class="field-value">${request.studentId}</span></div>
                                </div>
                                <div class="field-row">
                                    <div><span class="field-label">الصف:</span> <span class="field-value">${request.studentGrade}</span></div>
                                    <div><span class="field-label">السنة الدراسية:</span> <span class="field-value">${request.academicYear}</span></div>
                                </div>
                                <div class="field-row">
                                    <div><span class="field-label">الفصل الدراسي:</span> <span class="field-value">${getSemesterText(request.semester)}</span></div>
                                    <div><span class="field-label">تاريخ الإرسال:</span> <span class="field-value">${formatDateGregorian(request.submittedAt)}</span></div>
                                </div>
                                <div class="field-row">
                                    <div><span class="field-label">الحالة:</span> <span class="field-value status-${request.status}">${getStatusText(request.status)}</span></div>
                                    ${request.processedAt ? `<div><span class="field-label">تاريخ المعالجة:</span> <span class="field-value">${formatDateGregorian(request.processedAt)}</span></div>` : ''}
                                </div>
                                ${generatePrintSpecificFields(request)}
                                ${request.notes ? `<div style="margin-top: 15px;"><span class="field-label">ملاحظات:</span><br><span class="field-value">${request.notes}</span></div>` : ''}
                                ${request.rejectReason ? `<div style="margin-top: 15px; padding: 10px; background: #fef2f2; border-right: 4px solid #dc2626; border-radius: 6px;"><span class="field-label">سبب الرفض:</span><br><span class="field-value">${request.rejectReason}</span></div>` : ''}
                                ${request.archivedAt ? `<div style="margin-top: 15px; padding: 10px; background: #faf5ff; border-right: 4px solid #8b5cf6; border-radius: 6px;"><span class="field-label">تاريخ الأرشفة:</span><br><span class="field-value">${formatDateGregorian(request.archivedAt)}</span></div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    
                    <div class="footer">
                        <p>مدرسة الثروات الوطنية الخاصة - نظام إدارة شؤون الطلاب</p>
                        <p>تم إنشاء هذا التقرير بواسطة: ${currentUser.role} | IP: ${userIP}</p>
                    </div>
                </body>
                </html>
            `;
        }

        function printSelectedRequests() {
            if (selectedRequests.length === 0) {
                showCustomAlert('يرجى اختيار طلب واحد على الأقل للطباعة');
                return;
            }

            const requestsToPrint = allRequests.filter(r => selectedRequests.includes(r.id));
            printRequests(requestsToPrint);
        }

        function generatePrintSpecificFields(request) {
            let html = '';
            
            if (request.type === 'transfer') {
                html = `
                    <div class="field-row">
                        <div><span class="field-label">القسم الحالي:</span> <span class="field-value">${request.currentDepartment || '-'}</span></div>
                        <div><span class="field-label">القسم المطلوب:</span> <span class="field-value">${request.targetDepartment || '-'}</span></div>
                    </div>
                    ${request.transferReason ? `<div style="margin-top: 10px;"><span class="field-label">سبب النقل:</span><br><span class="field-value">${request.transferReason}</span></div>` : ''}
                `;
            } else if (request.type === 'certificate') {
                html = `<div class="field-row"><div><span class="field-label">نوع الشهادة:</span> <span class="field-value">${getCertificateTypeText(request.certificateType) || '-'}</span></div></div>`;
            } else if (request.type === 'unlock') {
                html = request.unlockReason ? `<div style="margin-top: 10px;"><span class="field-label">سبب إزالة اللوك:</span><br><span class="field-value">${request.unlockReason}</span></div>` : '';
            } else if (request.type === 'registration_completion') {
                html = `
                    <div class="field-row">
                        <div><span class="field-label">المرحلة الحالية:</span> <span class="field-value">${getStageText(request.currentStage) || '-'}</span></div>
                        <div><span class="field-label">الإجراء المطلوب:</span> <span class="field-value">${request.requiredAction || '-'}</span></div>
                    </div>
                    ${request.registrationDetails ? `<div style="margin-top: 10px;"><span class="field-label">تفاصيل إضافية:</span><br><span class="field-value">${request.registrationDetails}</span></div>` : ''}
                `;
            }
            
            return html;
        }

        // Export Functions
        function exportCurrentData() {
            if (currentScreen === 'studentAffairs') {
                exportStudentRequests();
            } else if (currentScreen === 'accounting') {
                exportAccountingRequests();
            } else {
                exportAllData();
            }
        }

        function exportStudentRequests() {
            const requests = allRequests.filter(r => r.submittedBy === currentUser.role);
            exportToExcel(requests, 'طلبات_شؤون_الطلاب');
        }

        function exportAccountingRequests() {
            const requests = allRequests.filter(r => r.submittedBy !== currentUser.role && r.status !== 'archived');
            exportToExcel(requests, 'طلبات_المحاسبة');
        }

        function exportAllData() {
            exportToExcel(allRequests, 'جميع_الطلبات');
        }

        function exportToExcel(data, filename) {
            if (data.length === 0) {
                showCustomAlert('لا توجد بيانات للتصدير');
                return;
            }

            const excelData = data.map(request => ({
                'نوع الطلب': getRequestTypeText(request.type),
                'اسم الطالب': request.studentName,
                'رقم الهوية': request.studentId,
                'الصف': request.studentGrade,
                'السنة الدراسية': request.academicYear,
                'الفصل الدراسي': getSemesterText(request.semester),
                'الحالة': getStatusText(request.status),
                'تاريخ الإرسال': formatDateGregorian(request.submittedAt),
                'مرسل بواسطة': request.submittedBy,
                'IP الإرسال': request.submittedFromIP || 'غير متاح',
                'تاريخ المعالجة': request.processedAt ? formatDateGregorian(request.processedAt) : '-',
                'معالج بواسطة': request.processedBy || '-',
                'IP المعالجة': request.processedFromIP || '-',
                'سبب الرفض': request.rejectReason || '-',
                'تاريخ الأرشفة': request.archivedAt ? formatDateGregorian(request.archivedAt) : '-',
                'مؤرشف بواسطة': request.archivedBy || '-',
                'ملاحظات': request.notes || '-',
                ...(request.type === 'transfer' && {
                    'القسم الحالي': request.currentDepartment || '-',
                    'القسم المطلوب': request.targetDepartment || '-',
                    'سبب النقل': request.transferReason || '-'
                }),
                ...(request.type === 'certificate' && {
                    'نوع الشهادة': getCertificateTypeText(request.certificateType) || '-'
                }),
                ...(request.type === 'unlock' && {
                    'سبب إزالة اللوك': request.unlockReason || '-'
                }),
                ...(request.type === 'registration_completion' && {
                    'المرحلة الحالية': getStageText(request.currentStage) || '-',
                    'الإجراء المطلوب': request.requiredAction || '-',
                    'تفاصيل التسجيل': request.registrationDetails || '-'
                })
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'البيانات');

            const title = [
                ['مدرسة الثروات الوطنية الخاصة'],
                ['تقرير طلبات شؤون الطلاب'],
                [`تاريخ التصدير: ${formatDateGregorian(new Date().toISOString())}`],
                [`مصدر بواسطة: ${currentUser.role}`],
                [`عنوان IP: ${userIP}`],
                ['']
            ];

            XLSX.utils.sheet_add_aoa(ws, title, { origin: 'A1' });

            const colWidths = Object.keys(excelData[0] || {}).map(() => ({ width: 20 }));
            ws['!cols'] = colWidths;

            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `${filename}_${timestamp}.xlsx`);
            
            showCustomAlert('تم تصدير الملف بنجاح');
        }

        // Request Details Modal
        function viewRequestDetails(requestId) {
            const request = allRequests.find(r => r.id === requestId);
            if (!request) return;
            
            let detailsHTML = `
                <div class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">نوع الطلب</label>
                            <p class="text-slate-900 dark:text-white font-bold text-lg">${getRequestTypeText(request.type)}</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">الحالة</label>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusStyle(request.status)}">${getStatusText(request.status)}</span>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">اسم الطالب</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.studentName}</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">رقم الهوية</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.studentId}</p>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">الصف</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.studentGrade}</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">السنة الدراسية</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.academicYear || '-'}</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">الفصل الدراسي</label>
                            <p class="text-slate-900 dark:text-white font-medium">${getSemesterText(request.semester)}</p>
                        </div>
                    </div>
            `;
            
            if (request.type === 'transfer') {
                detailsHTML += `
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
                            <label class="block text-sm font-medium text-blue-600 dark:text-blue-400 mb-2">القسم الحالي</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.currentDepartment || '-'}</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
                            <label class="block text-sm font-medium text-blue-600 dark:text-blue-400 mb-2">القسم المراد النقل إليه</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.targetDepartment || '-'}</p>
                        </div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
                        <label class="block text-sm font-medium text-blue-600 dark:text-blue-400 mb-2">سبب النقل</label>
                        <p class="text-slate-900 dark:text-white font-medium">${request.transferReason || '-'}</p>
                    </div>
                `;
            } else if (request.type === 'certificate') {
                detailsHTML += `
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4">
                        <label class="block text-sm font-medium text-green-600 dark:text-green-400 mb-2">نوع الشهادة</label>
                        <p class="text-slate-900 dark:text-white font-medium">${getCertificateTypeText(request.certificateType) || '-'}</p>
                    </div>
                `;
            } else if (request.type === 'unlock') {
                detailsHTML += `
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-xl p-4">
                        <label class="block text-sm font-medium text-yellow-600 dark:text-yellow-400 mb-2">سبب إزالة اللوك</label>
                        <p class="text-slate-900 dark:text-white font-medium">${request.unlockReason || '-'}</p>
                    </div>
                `;
            } else if (request.type === 'registration_completion') {
                detailsHTML += `
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4">
                            <label class="block text-sm font-medium text-purple-600 dark:text-purple-400 mb-2">المرحلة الحالية</label>
                            <p class="text-slate-900 dark:text-white font-medium">${getStageText(request.currentStage) || '-'}</p>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4">
                            <label class="block text-sm font-medium text-purple-600 dark:text-purple-400 mb-2">الإجراء المطلوب</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.requiredAction || '-'}</p>
                        </div>
                    </div>
                    ${request.registrationDetails ? `
                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4">
                            <label class="block text-sm font-medium text-purple-600 dark:text-purple-400 mb-2">تفاصيل إضافية</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.registrationDetails}</p>
                        </div>
                    ` : ''}
                `;
            }
            
            if (request.notes) {
                detailsHTML += `
                    <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">ملاحظات إضافية</label>
                        <p class="text-slate-900 dark:text-white font-medium">${request.notes}</p>
                    </div>
                `;
            }
            
            detailsHTML += `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">تاريخ الإرسال</label>
                        <p class="text-slate-900 dark:text-white font-medium">${formatDateGregorian(request.submittedAt)}</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">مرسل بواسطة</label>
                        <p class="text-slate-900 dark:text-white font-medium">${request.submittedBy}</p>
                    </div>
                </div>

                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">معلومات التتبع</label>
                    <div class="text-sm text-slate-600 dark:text-slate-300 space-y-1">
                        <p><span class="font-medium">عنوان IP للإرسال:</span> ${request.submittedFromIP || 'غير متاح'}</p>
                        <p><span class="font-medium">المستخدم:</span> ${request.submittedByUser || 'غير متاح'}</p>
                    </div>
                </div>
            `;
            
            if (request.processedAt) {
                detailsHTML += `
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">تاريخ المعالجة</label>
                            <p class="text-slate-900 dark:text-white font-medium">${formatDateGregorian(request.processedAt)}</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                            <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">معالج بواسطة</label>
                            <p class="text-slate-900 dark:text-white font-medium">${request.processedBy}</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">عنوان IP للمعالجة</label>
                        <p class="text-slate-900 dark:text-white font-medium">${request.processedFromIP || 'غير متاح'}</p>
                    </div>
                `;
            }

            if (request.archivedAt) {
                detailsHTML += `
                    <div class="bg-purple-50 dark:bg-purple-900/20 border-2 border-purple-200 dark:border-purple-800 rounded-xl p-6">
                        <div class="flex items-start space-x-3 space-x-reverse">
                            <i class="fas fa-archive text-purple-500 text-xl mt-1"></i>
                            <div>
                                <label class="block text-lg font-medium text-purple-700 dark:text-purple-300 mb-2">تفاصيل الأرشفة</label>
                                <div class="space-y-2 text-sm">
                                    <p class="text-purple-600 dark:text-purple-400"><span class="font-medium">تاريخ الأرشفة:</span> ${formatDateGregorian(request.archivedAt)}</p>
                                    <p class="text-purple-600 dark:text-purple-400"><span class="font-medium">مؤرشف بواسطة:</span> ${request.archivedBy}</p>
                                    <p class="text-purple-600 dark:text-purple-400"><span class="font-medium">عنوان IP:</span> ${request.archivedFromIP || 'غير متاح'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (request.rejectReason) {
                detailsHTML += `
                    <div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl p-6">
                        <div class="flex items-start space-x-3 space-x-reverse">
                            <i class="fas fa-times-circle text-red-500 text-xl mt-1"></i>
                            <div>
                                <label class="block text-lg font-medium text-red-700 dark:text-red-300 mb-2">سبب الرفض</label>
                                <p class="text-red-600 dark:text-red-400">${request.rejectReason}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            detailsHTML += `
                    ${currentUser.department === 'accounting' && request.status === 'pending' ? `
                        <div class="flex justify-end space-x-4 space-x-reverse pt-6 border-t-2 border-slate-200 dark:border-slate-700">
                            <button onclick="approveRequestFromModal('${request.id}')" class="btn-success text-white px-6 py-3 rounded-xl transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                <i class="fas fa-check"></i>
                                <span>موافقة</span>
                            </button>
                            <button onclick="rejectRequestFromModal('${request.id}')" class="btn-danger text-white px-6 py-3 rounded-xl transition-all shadow-lg flex items-center space-x-1 space-x-reverse">
                                <i class="fas fa-times"></i>
                                <span>رفض</span>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('requestDetailsContent').innerHTML = detailsHTML;
            document.getElementById('requestDetailsModal').classList.remove('hidden');
        }

        function approveRequestFromModal(requestId) {
            approveRequest(requestId);
            closeRequestDetails();
        }

        function rejectRequestFromModal(requestId) {
            closeRequestDetails();
            rejectRequest(requestId);
        }

        function closeRequestDetails() {
            document.getElementById('requestDetailsModal').classList.add('hidden');
        }

        // Notifications
        async function addNotification(department, message, type) {
            const notification = {
                department,
                message,
                type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            try {
                if (window.firebase) {
                    const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'notifications'), notification);
                    notification.id = docRef.id;
                }
                
                notifications.push(notification);
                localStorage.setItem('notifications', JSON.stringify(notifications));
                updateNotificationBadge();
                playNotificationSound();
                
            } catch (error) {
                console.error('Error adding notification:', error);
            }
        }

        function updateNotificationBadge() {
            const departmentNotifications = notifications.filter(n => 
                !n.read && 
                ((currentUser.department === 'studentAffairs' && n.department === 'studentAffairs') ||
                 (currentUser.department === 'accounting' && n.department === 'accounting'))
            );
            
            const badge = document.getElementById('notificationBadge');
            if (departmentNotifications.length > 0) {
                badge.textContent = departmentNotifications.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showNotifications() {
            const currentDepartment = currentUser.department;
            const departmentNotifications = notifications.filter(n => n.department === currentDepartment);
            
            if (departmentNotifications.length === 0) {
                document.getElementById('notificationsContent').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-bell-slash text-4xl text-slate-400 mb-4"></i>
                        <h4 class="text-lg font-medium text-slate-500 dark:text-slate-400 mb-2">لا توجد تنبيهات</h4>
                        <p class="text-slate-400 dark:text-slate-500 text-sm">ستظهر التنبيهات هنا عند وجود أحداث جديدة</p>
                    </div>
                `;
            } else {
                document.getElementById('notificationsContent').innerHTML = departmentNotifications
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map(notification => `
                        <div class="border-b-2 border-slate-200 dark:border-slate-600 pb-4 mb-4 last:border-b-0 notification-item p-3 ${notification.read ? '' : 'notification-unread'}">
                            <div class="flex items-start space-x-3 space-x-reverse">
                                <div class="flex-shrink-0 w-10 h-10 rounded-full ${getNotificationIconStyle(notification.type)} flex items-center justify-center">
                                    <i class="fas ${getNotificationIcon(notification.type)} text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-slate-900 dark:text-white font-medium leading-relaxed">${notification.message}</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 flex items-center">
                                        <i class="fas fa-clock mr-1"></i>
                                        ${formatDateGregorian(notification.timestamp)}
                                    </p>
                                </div>
                                ${!notification.read ? '<div class="w-3 h-3 bg-blue-500 rounded-full"></div>' : ''}
                            </div>
                        </div>
                    `).join('');
                    
                departmentNotifications.forEach(n => n.read = true);
                localStorage.setItem('notifications', JSON.stringify(notifications));
            }
            
            document.getElementById('notificationsModal').classList.remove('hidden');
            updateNotificationBadge();
        }

        function closeNotifications() {
            document.getElementById('notificationsModal').classList.add('hidden');
        }

        // Utility Functions
        function getRequestTypeText(type) {
            const types = {
                transfer: 'نقل طالب',
                certificate: 'إصدار شهادة',
                unlock: 'إزالة لوك',
                registration_completion: 'إكمال إجراء التسجيل'
            };
            return types[type] || type;
        }

        function getRequestTypeIcon(type) {
            const icons = {
                transfer: 'fas fa-exchange-alt',
                certificate: 'fas fa-certificate',
                unlock: 'fas fa-unlock',
                registration_completion: 'fas fa-user-plus'
            };
            return icons[type] || 'fas fa-file';
        }

        function getCertificateTypeText(type) {
            const types = {
                enrollment: 'شهادة إثبات قيد',
                grades: 'شهادة درجات',
                graduation: 'شهادة تخرج',
                conduct: 'شهادة حسن سير وسلوك'
            };
            return types[type] || type;
        }

        function getStageText(stage) {
            const stages = {
                documents_submission: 'تسليم الوثائق',
                medical_examination: 'الفحص الطبي',
                fees_payment: 'دفع الرسوم',
                final_approval: 'الموافقة النهائية'
            };
            return stages[stage] || stage;
        }

        function getSemesterText(semester) {
            const semesters = {
                first: 'الفصل الأول',
                second: 'الفصل الثاني',
                third: 'الفصل الثالث'
            };
            return semesters[semester] || semester;
        }

        function getStatusText(status) {
            const statuses = {
                pending: 'قيد المراجعة',
                approved: 'مقبول',
                rejected: 'مرفوض',
                archived: 'مؤرشف'
            };
            return statuses[status] || status;
        }

        function getStatusStyle(status) {
            const styles = {
                pending: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
                approved: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
                rejected: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
                archived: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300'
            };
            return styles[status] || '';
        }

        function getNotificationIcon(type) {
            const icons = {
                new: 'fa-plus-circle',
                approved: 'fa-check-circle',
                rejected: 'fa-times-circle'
            };
            return icons[type] || 'fa-bell';
        }

        function getNotificationIconStyle(type) {
            const styles = {
                new: 'bg-blue-500',
                approved: 'bg-green-500',
                rejected: 'bg-red-500'
            };
            return styles[type] || 'bg-slate-500';
        }

        function formatDateGregorian(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(',', ' -');
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="modal-content max-w-sm w-full mx-4 slide-in p-8">
                    <div class="flex items-center space-x-3 space-x-reverse mb-6">
                        <div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center">
                            <i class="fas fa-info-circle text-white text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">تنبيه</h3>
                    </div>
                    <p class="text-slate-700 dark:text-slate-300 mb-6 leading-relaxed">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="btn-primary text-white px-6 py-3 hover:opacity-90 rounded-xl transition-all shadow-lg">
                            موافق
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 5000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateNotificationBadge();
        });
    </script>
</body>
</html>
